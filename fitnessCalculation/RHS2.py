'''
RHS =  [[0, 0, 0, 2], [6, 5, 1, 8], [6, 1, 1, 7], [2, 5, 1, 9], [5, 1, 2, 3], [7, 2, 2, 0], [0, 2, 0, 4], [4, 1, 2, 4], [7, 0, 2, 2], [6, 0, 1, 5], [4, 3, 2, 3], [1, 4, 0, 4], [9, 0, 1, 4], [5, 0, 2, 6], [8, 0, 0, 1], [2, 3, 1, 6], [9, 1, 1, 9], [7, 8, 2, 6], [3, 3, 1, 10], [2, 0, 1, 12], [9, 2, 1, 13], [0, 0, 1, 6], [2, 3, 0, 5], [3, 5, 1, 7], [8, 0, 1, 9], [0, 2, 1, 8], [1, 4, 2, 0], [6, 0, 0, 0], [7, 8, 0, 3], [7, 3, 2, 6], [9, 3, 1, 2], [4, 2, 2, 5], [1, 1, 0, 0], [6, 5, 0, 4], [3, 0, 1, 13], [3, 4, 1, 6], [1, 3, 0, 2], [8, 1, 0, 1], [1, 1, 2, 1], [2, 6, 1, 2], [3, 1, 1, 7], [1, 3, 2, 1], [6, 2, 1, 1], [3, 4, 2, 7], [3, 3, 2, 3], [6, 6, 1, 7], [2, 5, 0, 2], [3, 0, 2, 3], [3, 5, 2, 1], [7, 7, 2, 0], [2, 3, 3, 1], [4, 2, 0, 4], [9, 0, 0, 3], [4, 3, 0, 5], [7, 0, 0, 5], [2, 4, 1, 7], [2, 6, 0, 5], [5, 0, 1, 5], [7, 7, 0, 0], [0, 0, 2, 1], [2, 0, 0, 0], [3, 2, 1, 7], [3, 3, 0, 4], [7, 4, 2, 7], [3, 4, 0, 5], [8, 0, 3, 4], [6, 3, 1, 1], [0, 2, 2, 1], [2, 2, 1, 1], [9, 0, 2, 7], [8, 2, 0, 1], [9, 0, 6, 2], [9, 4, 1, 9], [3, 5, 0, 1], [2, 5, 3, 0], [8, 2, 1, 8], [6, 5, 3, 2], [2, 0, 3, 1], [4, 3, 1, 1], [6, 0, 3, 3], [4, 1, 0, 4], [6, 6, 0, 3], [7, 7, 1, 4], [9, 3, 0, 5], [7, 5, 2, 5], [8, 2, 3, 3], [8, 0, 5, 1], [2, 6, 3, 0], [8, 1, 1, 7], [9, 4, 0, 0], [7, 6, 2, 7], [0, 1, 0, 5], [2, 3, 2, 3], [7, 4, 0, 4], [4, 1, 1, 8], [0, 0, 3, 1], [4, 1, 5, 0], [0, 2, 3, 3], [4, 2, 1, 2], [2, 2, 0, 4], [6, 4, 1, 0], [7, 4, 1, 12], [3, 2, 2, 4], [3, 1, 2, 2], [7, 6, 0, 1], [3, 4, 4, 5], [6, 5, 2, 5], [7, 3, 0, 2], [3, 4, 6, 3], [1, 4, 4, 2], [3, 1, 0, 1], [2, 5, 2, 2], [9, 2, 0, 3], [8, 0, 2, 1], [2, 1, 1, 3], [0, 1, 1, 11], [2, 2, 3, 1], [9, 2, 2, 5], [4, 0, 2, 4], [7, 5, 0, 2], [0, 2, 4, 2], [6, 1, 0, 0], [4, 2, 5, 6], [6, 3, 0, 5], [3, 3, 4, 5], [9, 1, 0, 3], [1, 3, 4, 4], [0, 2, 5, 7], [8, 2, 5, 4], [6, 3, 3, 1], [3, 2, 0, 2], [8, 2, 2, 5], [2, 6, 2, 4], [2, 5, 8, 0], [1, 2, 0, 5], [3, 5, 4, 0], [4, 3, 5, 1], [0, 2, 6, 2], [4, 0, 0, 5], [6, 6, 3, 0], [9, 1, 2, 0], [1, 2, 2, 0], [8, 1, 3, 0], [1, 0, 0, 2], [1, 0, 2, 0], [2, 2, 2, 7], [6, 0, 2, 7], [7, 3, 1, 9], [7, 5, 1, 0], [2, 2, 8, 3], [2, 2, 5, 3], [3, 1, 4, 0], [3, 1, 6, 1], [3, 5, 6, 0], [2, 2, 7, 4], [6, 5, 6, 1], [1, 2, 4, 5], [7, 6, 1, 10], [2, 6, 8, 0], [8, 2, 9, 1], [7, 2, 0, 4], [3, 0, 0, 3], [1, 1, 4, 5], [9, 2, 6, 2], [0, 0, 4, 5], [7, 4, 5, 1], [4, 2, 3, 2], [1, 1, 9, 0], [9, 4, 2, 7], [1, 2, 9, 1], [9, 3, 2, 3], [9, 2, 8, 0], [6, 0, 6, 2], [6, 5, 5, 1], [7, 7, 5, 0], [2, 0, 2, 2], [1, 3, 9, 1], [6, 6, 2, 5], [6, 0, 5, 5], [4, 3, 3, 0], [3, 4, 8, 4], [1, 4, 9, 0], [1, 0, 4, 5], [4, 1, 3, 4], [0, 2, 7, 0], [7, 4, 4, 1], [7, 8, 1, 1], [9, 3, 6, 1], [6, 1, 3, 3], [7, 6, 5, 3], [7, 2, 1, 2], [2, 3, 8, 1], [9, 1, 6, 0], [9, 2, 9, 1], [4, 0, 1, 6], [5, 1, 1, 13], [7, 1, 2, 4], [1, 1, 3, 1], [1, 1, 1, 8], [5, 0, 5, 7], [3, 4, 7, 1], [6, 3, 2, 2], [6, 2, 0, 4], [9, 0, 8, 5], [2, 6, 5, 0], [1, 3, 3, 4], [9, 4, 6, 1], [7, 2, 5, 7], [2, 1, 0, 1], [2, 6, 7, 2], [7, 5, 5, 7], [1, 3, 1, 9], [8, 0, 9, 0], [6, 4, 0, 5], [1, 3, 6, 0], [5, 0, 3, 3], [2, 5, 5, 5], [3, 0, 4, 2], [6, 2, 3, 3], [7, 5, 4, 5], [7, 8, 5, 0], [9, 0, 9, 1], [6, 1, 2, 4], [6, 2, 2, 6], [2, 4, 0, 5], [4, 1, 4, 2], [8, 1, 5, 7], [7, 1, 0, 0], [1, 2, 3, 2], [1, 2, 1, 4], [1, 4, 3, 0], [7, 1, 1, 0], [2, 3, 5, 3], [3, 3, 6, 0], [7, 2, 4, 1], [3, 5, 8, 3], [6, 1, 6, 3], [7, 3, 5, 2], [9, 4, 8, 4], [4, 0, 5, 2], [1, 1, 6, 2], [9, 3, 8, 6], [7, 6, 4, 2], [4, 1, 8, 6], [6, 0, 9, 1], [9, 0, 5, 7], [7, 0, 1, 13], [2, 3, 7, 1], [2, 5, 7, 1], [9, 4, 9, 1], [8, 0, 6, 0], [3, 2, 4, 1], [2, 4, 3, 0], [7, 5, 6, 1], [8, 2, 6, 2], [8, 0, 7, 5], [6, 3, 6, 0], [6, 4, 3, 2], [6, 4, 2, 4], [6, 2, 6, 2], [1, 0, 9, 1], [6, 3, 5, 7], [3, 0, 6, 0], [7, 3, 4, 1], [1, 4, 1, 10], [6, 2, 5, 3], [3, 0, 8, 5], [7, 5, 8, 3], [8, 1, 2, 3], [6, 1, 5, 8], [3, 2, 6, 0], [7, 7, 4, 0], [9, 2, 5, 7], [6, 1, 9, 1], [7, 2, 6, 2], [9, 1, 8, 3], [9, 2, 3, 3], [5, 1, 5, 3], [1, 3, 5, 4], [1, 0, 3, 0], [5, 0, 7, 3], [2, 1, 3, 0], [7, 3, 6, 1], [6, 2, 9, 0], [7, 8, 4, 5], [7, 1, 5, 0], [3, 1, 8, 0], [9, 1, 9, 0], [9, 4, 5, 6], [7, 7, 6, 2], [7, 6, 6, 2], [2, 3, 6, 1], [6, 4, 6, 1], [6, 6, 6, 1], [7, 8, 6, 3], [7, 2, 8, 0], [7, 8, 8, 5], [1, 0, 1, 6], [4, 0, 3, 4], [7, 1, 4, 0], [4, 3, 4, 5], [4, 0, 4, 2], [7, 4, 6, 1], [2, 5, 6, 0], [2, 3, 9, 1], [6, 2, 8, 0], [0, 1, 2, 7], [1, 0, 6, 1], [4, 0, 8, 5], [7, 0, 5, 1], [3, 0, 7, 0], [6, 6, 5, 3], [6, 3, 9, 0], [9, 4, 3, 3], [8, 1, 9, 0], [9, 3, 9, 0], [2, 1, 2, 2], [1, 1, 5, 2], [0, 1, 3, 3], [2, 5, 9, 0], [1, 2, 6, 2], [7, 3, 8, 1], [5, 0, 4, 3], [7, 8, 9, 1], [7, 8, 7, 2], [0, 0, 5, 7], [6, 2, 7, 3], [2, 6, 6, 1], [7, 1, 6, 3], [7, 8, 3, 2], [2, 2, 6, 3], [6, 0, 8, 4], [2, 0, 8, 6], [9, 4, 4, 4], [1, 2, 5, 5], [2, 4, 2, 0], [3, 3, 8, 4], [0, 0, 6, 0], [7, 5, 9, 0], [6, 5, 9, 1], [7, 1, 8, 2], [6, 6, 9, 0], [1, 4, 6, 0], [3, 2, 8, 4], [2, 0, 5, 8], [8, 2, 7, 4], [7, 7, 8, 2], [9, 3, 5, 8], [7, 5, 7, 1], [2, 6, 9, 0], [6, 4, 5, 2], [7, 6, 8, 1], [8, 1, 6, 2], [7, 1, 9, 0], [3, 5, 7, 0], [3, 3, 7, 5], [4, 1, 7, 2], [4, 2, 4, 2], [6, 2, 4, 1], [3, 1, 7, 4], [5, 0, 0, 5], [3, 4, 3, 3], [2, 1, 8, 4], [7, 7, 9, 0], [9, 0, 3, 3], [4, 2, 8, 4], [2, 1, 5, 3], [6, 1, 8, 3], [7, 1, 7, 4], [2, 4, 8, 0], [7, 4, 8, 2], [6, 4, 9, 0], [6, 3, 8, 0], [9, 1, 5, 0], [0, 1, 4, 3], [9, 1, 3, 2], [1, 0, 5, 4], [1, 4, 5, 2], [3, 1, 3, 3], [2, 0, 7, 0], [6, 3, 7, 2], [6, 0, 7, 2], [9, 1, 4, 1], [3, 2, 7, 5], [7, 0, 4, 5], [0, 1, 5, 6], [0, 1, 6, 2], [4, 3, 8, 1], [6, 5, 8, 1], [3, 5, 3, 1], [4, 3, 7, 4], [2, 4, 5, 7], [3, 3, 3, 3], [2, 0, 6, 1], [8, 2, 4, 2], [2, 0, 9, 1], [8, 0, 4, 1], [0, 0, 7, 1], [2, 2, 9, 1], [2, 3, 4, 0], [5, 1, 3, 1], [3, 2, 3, 4], [1, 3, 7, 1], [6, 6, 8, 6], [9, 4, 7, 4], [1, 4, 7, 3], [7, 7, 7, 5], [7, 0, 6, 0], [2, 4, 7, 4], [4, 3, 9, 0], [0, 0, 8, 4], [1, 1, 7, 1], [5, 1, 7, 4], [7, 0, 8, 2], [7, 2, 9, 0], [8, 0, 8, 2], [9, 2, 4, 2], [6, 4, 8, 2], [7, 5, 3, 0], [3, 2, 9, 0], [2, 2, 4, 3], [7, 2, 7, 5], [6, 0, 4, 4], [8, 2, 8, 3], [6, 5, 7, 3], [2, 5, 4, 5], [6, 1, 7, 3], [3, 0, 3, 3], [2, 1, 7, 0], [8, 1, 7, 3], [9, 2, 7, 1], [7, 3, 9, 1], [3, 2, 5, 1], [0, 0, 9, 1], [2, 4, 6, 0], [7, 4, 9, 0], [7, 3, 7, 4], [1, 4, 8, 2], [3, 4, 9, 1], [0, 2, 8, 0], [0, 2, 9, 1], [5, 0, 6, 0], [2, 4, 9, 0], [1, 0, 7, 4], [8, 1, 4, 3], [4, 3, 6, 2], [2, 1, 6, 3], [6, 3, 4, 0], [9, 3, 3, 3], [1, 2, 7, 2], [7, 4, 7, 1], [4, 2, 7, 1], [2, 4, 4, 5], [3, 3, 9, 1], [7, 6, 9, 0], [6, 4, 7, 0], [6, 4, 4, 3], [3, 5, 9, 0], [3, 1, 9, 1], [7, 2, 3, 1], [1, 0, 8, 1], [5, 1, 4, 2], [2, 0, 4, 2], [6, 5, 4, 3], [3, 0, 9, 0], [0, 1, 7, 0], [1, 2, 8, 4], [9, 0, 4, 5], [1, 1, 8, 2], [2, 1, 9, 1], [9, 3, 4, 1], [7, 0, 9, 0], [7, 4, 3, 1], [4, 1, 9, 1], [8, 1, 8, 3], [3, 0, 5, 2], [7, 1, 3, 2], [0, 1, 8, 1], [6, 1, 4, 1], [0, 1, 9, 1], [4, 1, 6, 3], [3, 3, 5, 6], [3, 5, 5, 2], [2, 6, 4, 3], [5, 1, 0, 2], [4, 2, 9, 1], [1, 3, 8, 3], [9, 1, 7, 1], [7, 0, 7, 5], [7, 6, 7, 1], [3, 4, 5, 4], [3, 1, 5, 0], [7, 3, 3, 3], [9, 3, 7, 2], [4, 0, 7, 1], [9, 0, 7, 1], [6, 6, 7, 0], [7, 7, 3, 0], [6, 6, 4, 4], [7, 0, 3, 2], [2, 1, 4, 3], [4, 0, 9, 1], [5, 1, 6, 2], [7, 6, 3, 1], [4, 2, 6, 2], [4, 0, 6, 2]]

lot_size = [[1000, 500, 500], [1500, 1000, 1000, 1000, 500], [3000, 3500, 500, 2000, 1000, 2500, 2000], [500, 1500, 2500, 500, 500, 3500], [2000, 2000, 1500, 1000], [2000, 2500], [500, 500, 1500, 500, 500, 1000, 1000], [500, 500, 500, 500, 1500, 1000, 1000, 1500, 500], [2500, 4500, 2500], [2500, 3500, 2500, 1000, 3000]]
print(len(RHS))
demand = [2000, 5000, 14000, 8000, 6000, 4500, 3800, 7000, 9000, 12000]

processing_time = [[29,78,9,36,49,11,62,56,44,21],
[43,90,75,11,69,28,46,46,72,30],
[91,85,39,74,90,10,12,89,45,33],
[81,95,71,99,9,52,85,98,22,43],
[14,6,22,61,26,69,21,49,72,53],
[84,2,52,95,48,72,47,65],
[46,37,61,13,32,21,32,89,30,55],
[31,86,46,74,32,88,19,48,36,79],
[76,69,76,51,85,11,40,89,26,74],
[85,13,61,7,64,76,47,52,90,45]]

max_sublot = [3, 5, 7, 6, 4, 2, 7, 9, 3, 5]
mc_op = [6, 14, 8, 5, 6, 9, 4, 6, 7, 2]
job_count = 10
sequence = [[0, 1, 2, 3, 4, 5, 6, 7, 8, 9], 
[0, 2, 4, 9, 3, 1, 6, 5, 7, 8], 
[1, 0, 3, 2, 8, 5, 7, 6, 9, 4], 
[1, 2, 0, 4, 6, 8, 7, 3, 9, 5], 
[2, 0, 1, 5, 3, 4, 8, 7, 9, 6], 
[2, 1, 5, 3, 7, 4, 0, 6], 
[1, 0, 3, 2, 6, 5, 9, 8, 7, 4], 
[2, 0, 1, 5, 4, 6, 8, 9, 7, 3], 
[0, 1, 3, 5, 2, 9, 6, 7, 4, 8], 
[1, 0, 2, 6, 8, 9, 5, 3, 4, 7]]

setup_time = [17400,46800,5400,21600,29400,6600,37200,33600,26400,12600]
start_date = 1532739600

import time
start = time.time()
'''

# Calculate Run time per sublot
def run_time(r, lot_size, RHS, sequence, processing_time):
    procTime = processing_time[RHS[r][0]][sequence[RHS[r][0]].index(RHS[r][2])] * lot_size[RHS[r][0]][RHS[r][1]]
    return procTime     

#Calculate finished time per sublot 
def lot_finished_timeCalculation(lot_size, RHS, setup_time, processing_time, sequence, mc_op):    
    machine_assigne_time =[[0 for i in range(mc_op[k])] for k in range(len(mc_op))]
    max_c = [0 for i in range(len(lot_size))]
    completion_time = [0 for i in range(len(RHS))]    
    
    # Check all indices of RHS (Step 2 + 3 + 6)
    for r in range(len(RHS)):
        procTime = run_time(r, lot_size, RHS, sequence, processing_time) + setup_time[RHS[r][2]]
        
        #print(procTime)
        if lot_size[RHS[r][0]][RHS[r][1]] > 0:                                    # Lot size not zero (Step 4)
            if (machine_assigne_time[RHS[r][2]][RHS[r][3]] == 0 and RHS[r][2] == sequence[RHS[r][0]][0]):
                # Step 5.1: First assignment to machine m and operation equal first operation in sequence
                
                completion_time[r] = procTime
                machine_assigne_time[RHS[r][2]][RHS[r][3]] +=1
    
            elif (machine_assigne_time[RHS[r][2]][RHS[r][3]] == 0 and RHS[r][2] != sequence[RHS[r][0]][0]):
                # Step 5.2: First assignment to machine m and operation over first operation in sequence
                    
                curent_sequence_index = sequence[RHS[r][0]].index(RHS[r][2])                              # Calculate index sequence of current chromosome
                prev_sequence = sequence[RHS[r][0]][curent_sequence_index-1]                              # Return previous sequence operation of current chromosome
                prev_operation_comp_index = [i[0:3] for i in RHS].index([RHS[r][0], RHS[r][1], prev_sequence])      # Return previous chromosome of current job + sublot
                
                completion_time[r] = max(setup_time[RHS[r][2]], completion_time[prev_operation_comp_index]) + procTime
                machine_assigne_time[RHS[r][2]][RHS[r][3]] +=1
                #print(curent_sequence_index, RHS[r])    
            elif (machine_assigne_time[RHS[r][2]][RHS[r][3]] > 0 and RHS[r][2] == sequence[RHS[r][0]][0]):
                # Step 5.3: First operation in sequence and machine m assignment > 1 (dung de xem xet khi co su khac nhau giua setup time ban dau, va setup time doi part) 
                
                prev_op_mc_RHS_index_list = []
                prev_op_mc_RHS_index = max([i for i, al in enumerate(RHS[:r]) if RHS[r][2:] == al[2:]])
                completion_time[r] = completion_time[prev_op_mc_RHS_index] + procTime
                machine_assigne_time[RHS[r][2]][RHS[r][3]] +=1
                    
            else:
                # Step 5.4 Operation over first operation in sequence and machine m assignment > 1
                    
                curent_sequence_index = sequence[RHS[r][0]].index(RHS[r][2])                              # Calculate index sequence of current chromosome
                prev_sequence = sequence[RHS[r][0]][curent_sequence_index-1]                              # Return previous sequence operation of current chromosome
                prev_operation_comp_index = [i[0:3] for i in RHS].index([RHS[r][0], RHS[r][1], prev_sequence])      # Return previous chromosome of current job + sublot
              
                prev_op_mc_RHS_index = max([i for i, al in enumerate(RHS[:r]) if RHS[r][2:] == al[2:]])
                
                completion_time[r] = max(completion_time[prev_operation_comp_index], completion_time[prev_op_mc_RHS_index]) + procTime
                machine_assigne_time[RHS[r][2]][RHS[r][3]] +=1

            
        if max_c[RHS[r][0]] < completion_time[r]:
            max_c[RHS[r][0]] = completion_time[r] 
    makespan = max(max_c)    
                           
    return makespan, max_c, completion_time

#print(lot_finished_timeCalculation(lot_size, RHS, setup_time, processing_time, sequence, mc_op))
#end = time.time()
#print(end - start)
#Calculate finished time per sublot 
def makespan_timeCalculation(lot_size, RHS, setup_time, processing_time, sequence, mc_op):    
    machine_assigne_time =[[0 for i in range(mc_op[k])] for k in range(len(mc_op))]
    max_c = [0 for i in range(len(lot_size))]
    completion_time = [0 for i in range(len(RHS))]    
    
    # Check all indices of RHS (Step 2 + 3 + 6)
    for r in range(len(RHS)):
        procTime = run_time(r, lot_size, RHS, sequence, processing_time) + setup_time[RHS[r][2]]
        
        #print(procTime)
        if lot_size[RHS[r][0]][RHS[r][1]] > 0:                                    # Lot size not zero (Step 4)
            if (machine_assigne_time[RHS[r][2]][RHS[r][3]] == 0 and RHS[r][2] == sequence[RHS[r][0]][0]):
                # Step 5.1: First assignment to machine m and operation equal first operation in sequence
                
                completion_time[r] = setup_time[RHS[r][2]] + procTime
                machine_assigne_time[RHS[r][2]][RHS[r][3]] +=1
    
            elif (machine_assigne_time[RHS[r][2]][RHS[r][3]] == 0 and RHS[r][2] != sequence[RHS[r][0]][0]):
                # Step 5.2: First assignment to machine m and operation over first operation in sequence
                    
                curent_sequence_index = sequence[RHS[r][0]].index(RHS[r][2])                              # Calculate index sequence of current chromosome
                prev_sequence = sequence[RHS[r][0]][curent_sequence_index-1]                              # Return previous sequence operation of current chromosome
                prev_operation_comp_index = [i[0:3] for i in RHS].index([RHS[r][0], RHS[r][1], prev_sequence])      # Return previous chromosome of current job + sublot
                
                completion_time[r] = max(setup_time[RHS[r][2]], completion_time[prev_operation_comp_index]) + procTime
                machine_assigne_time[RHS[r][2]][RHS[r][3]] +=1
                #print(curent_sequence_index, RHS[r])    
            elif (machine_assigne_time[RHS[r][2]][RHS[r][3]] > 0 and RHS[r][2] == sequence[RHS[r][0]][0]):
                # Step 5.3: First operation in sequence and machine m assignment > 1 (dung de xem xet khi co su khac nhau giua setup time ban dau, va setup time doi part) 
                
                prev_op_mc_RHS_index_list = []
                prev_op_mc_RHS_index = max([i for i, al in enumerate(RHS[:r]) if RHS[r][2:] == al[2:]])
                completion_time[r] = completion_time[prev_op_mc_RHS_index] + procTime
                machine_assigne_time[RHS[r][2]][RHS[r][3]] +=1
                    
            elif (machine_assigne_time[RHS[r][2]][RHS[r][3]] > 0 and RHS[r][2] != sequence[RHS[r][0]][0]):
                # Step 5.4 Operation over first operation in sequence and machine m assignment > 1
                    
                curent_sequence_index = sequence[RHS[r][0]].index(RHS[r][2])                              # Calculate index sequence of current chromosome
                prev_sequence = sequence[RHS[r][0]][curent_sequence_index-1]                              # Return previous sequence operation of current chromosome
                prev_operation_comp_index = [i[0:3] for i in RHS].index([RHS[r][0], RHS[r][1], prev_sequence])      # Return previous chromosome of current job + sublot              
                prev_op_mc_RHS_index = max([i for i, al in enumerate(RHS[:r]) if RHS[r][2:] == al[2:]])                
                completion_time[r] = max(completion_time[prev_operation_comp_index], completion_time[prev_op_mc_RHS_index]) + procTime
                machine_assigne_time[RHS[r][2]][RHS[r][3]] +=1
            
        max_c[RHS[r][0]] = max(max_c[RHS[r][0]], completion_time[r])
    makespan = max(max_c)    
                           
    return makespan